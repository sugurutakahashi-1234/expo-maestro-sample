name: VRT Baseline Update

# main ãƒ–ãƒ©ãƒ³ãƒã«ãƒžãƒ¼ã‚¸ã•ã‚ŒãŸã¨ãã«ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°
on:
  push:
    branches:
      - main

permissions:
  statuses: write  # reg-notify-github-plugin ãŒã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®š

jobs:
  # ========================================
  # Maestro ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³
  # ========================================
  maestro-baseline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆgit logç”¨ï¼‰

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.VRT_GCS_CREDENTIALS_JSON }}'

      - name: Publish to GCS
        working-directory: apps/cool-app
        run: |
          # ã‚­ãƒ¼å½¢å¼: {branch}/{version}/{hash}/maestro
          HASH=$(git rev-parse --short=7 HEAD)
          BRANCH="${{ github.ref_name }}"
          BRANCH_SAFE=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          VERSION=$(npx expo config --json | jq -r '.version')
          FULL_KEY="$BRANCH_SAFE/$VERSION/$HASH/maestro"
          echo "ðŸ” Publishing Maestro baseline to GCS"
          echo "KEY: $FULL_KEY"
          rm -rf .reg
          ACTUAL_DIR=.maestro/screenshots \
          EXPECTED_KEY=$FULL_KEY \
          ACTUAL_KEY=$FULL_KEY \
          bunx reg-suit run

      - name: Summary
        if: always()
        run: |
          HASH=$(git rev-parse --short=7 HEAD)
          VERSION=$(cd apps/cool-app && npx expo config --json | jq -r '.version')
          BRANCH="${{ github.ref_name }}"
          echo "## Maestro VRT Baseline Update" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: $BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "- Version: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: $HASH" >> $GITHUB_STEP_SUMMARY
          echo "- Key: $BRANCH/$VERSION/$HASH/maestro" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Maestro ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãŒ GCS ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Playwright ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³
  # ========================================
  playwright-baseline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: apps/cool-app
        # Chromium: Chrome/Edgeç³»ã€WebKit: Safariç³»
        # 4ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆchromium-desktop, webkit-desktop, iphone, pixelï¼‰ã§ä½¿ç”¨
        run: bunx playwright install chromium webkit --with-deps

      - name: Run Playwright tests
        working-directory: apps/cool-app
        run: bun run playwright
        env:
          CI: true

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.VRT_GCS_CREDENTIALS_JSON }}'

      - name: Publish to GCS
        working-directory: apps/cool-app
        run: |
          # ã‚­ãƒ¼å½¢å¼: {branch}/{version}/{hash}/playwright
          HASH=$(git rev-parse --short=7 HEAD)
          BRANCH="${{ github.ref_name }}"
          BRANCH_SAFE=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          VERSION=$(npx expo config --json | jq -r '.version')
          FULL_KEY="$BRANCH_SAFE/$VERSION/$HASH/playwright"
          echo "ðŸ” Publishing Playwright baseline to GCS"
          echo "KEY: $FULL_KEY"
          rm -rf .reg
          ACTUAL_DIR=playwright/screenshots \
          EXPECTED_KEY=$FULL_KEY \
          ACTUAL_KEY=$FULL_KEY \
          bunx reg-suit run

      - name: Summary
        if: always()
        run: |
          HASH=$(git rev-parse --short=7 HEAD)
          VERSION=$(cd apps/cool-app && npx expo config --json | jq -r '.version')
          BRANCH="${{ github.ref_name }}"
          echo "## Playwright VRT Baseline Update" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: $BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "- Version: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: $HASH" >> $GITHUB_STEP_SUMMARY
          echo "- Key: $BRANCH/$VERSION/$HASH/playwright" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Playwright ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãŒ GCS ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
