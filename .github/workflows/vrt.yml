name: Visual Regression Testing

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  vrt:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆgit rev-parseã§ä½¿ç”¨ï¼‰

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install
        working-directory: apps/cool-app

      - name: Setup Java (for Maestro)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "${HOME}/.maestro/bin" >> $GITHUB_PATH

      - name: Setup iOS Simulator
        run: |
          # åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’ãƒªã‚¹ãƒˆ
          xcrun simctl list devices available

          # iPhone 15 Proã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’èµ·å‹•ï¼ˆã¾ãŸã¯ä»»æ„ã®ãƒ‡ãƒã‚¤ã‚¹ï¼‰
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 Pro" | head -1 | grep -o '[A-F0-9-]\{36\}')
          xcrun simctl boot $DEVICE_ID || true

          # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          for i in {1..30}; do
            if xcrun simctl list | grep -q "Booted"; then
              echo "Simulator is ready"
              break
            fi
            echo "Waiting for simulator to boot... ($i/30)"
            sleep 2
          done

      - name: Build and run Expo app
        run: |
          cd apps/cool-app
          # Expoã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          bun run ios --no-interactive
        timeout-minutes: 20

      - name: Run Maestro E2E tests (iOS)
        run: |
          cd apps/cool-app
          bun run maestro:ios

      # PRã®å ´åˆ: mainãƒ–ãƒ©ãƒ³ãƒã¨æ¯”è¼ƒ
      - name: Run VRT (Pull Request)
        if: github.event_name == 'pull_request'
        env:
          EXPECTED_KEY: ${{ github.event.pull_request.base.sha }}
          ACTUAL_KEY: ${{ github.sha }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCP_SA_KEY_PATH }}
        run: |
          cd apps/cool-app
          # GCPèªè¨¼æƒ…å ±ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—
          echo "${{ secrets.GCP_SA_KEY }}" > /tmp/gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json

          bun run vrt:ci

      # mainã¸ã®push: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’è‡ªå‹•æ›´æ–°
      - name: Update VRT baseline (Push to main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          ACTUAL_KEY: ${{ github.sha }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCP_SA_KEY_PATH }}
        run: |
          cd apps/cool-app
          # GCPèªè¨¼æƒ…å ±ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—
          echo "${{ secrets.GCP_SA_KEY }}" > /tmp/gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json

          bun run vrt:ci:update-base

      - name: Upload VRT report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vrt-report
          path: apps/cool-app/.reg/

      - name: Comment PR with VRT results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outJson = JSON.parse(fs.readFileSync('apps/cool-app/.reg/out.json', 'utf8'));

            const comment = `## ðŸ“¸ Visual Regression Testing Results

            - âœ… Passed: ${outJson.passedItems.length}
            - ðŸ”´ Changed: ${outJson.failedItems.length}
            - ðŸ†• New: ${outJson.newItems.length}
            - ðŸ—‘ï¸ Deleted: ${outJson.deletedItems.length}

            ${outJson.failedItems.length > 0 ? '### Changed Screenshots:\n' + outJson.failedItems.map(item => `- ${item}`).join('\n') : ''}

            ðŸ“Š [View Full Report](https://storage.googleapis.com/vrt-sample/${{ github.sha }}/index.html)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
