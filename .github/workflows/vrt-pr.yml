name: VRT PR Comparison

# PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸã¨ãã«VRTæ¯”è¼ƒã‚’å®Ÿè¡Œ
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write       # peaceiris/actions-gh-pages ãŒ gh-pages ã«push
  pull-requests: write  # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
  statuses: write       # ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
  pages: write          # GitHub Pages ã¸ã®æ›¸ãè¾¼ã¿
  id-token: write       # OIDC ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ç”¨

jobs:
  # ========================================
  # Maestro VRT
  # ========================================
  maestro-vrt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Check VRT conditions
        id: check
        run: |
          echo "ğŸ” Checking Maestro VRT execution conditions..."

          # ã‚³ãƒ¼ãƒ‰ç³»ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãƒã‚§ãƒƒã‚¯ï¼ˆ.ts, .tsx, .js, .jsx, .json, .yamlï¼‰
          CODE_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '\.(ts|tsx|js|jsx|json|yaml)$' || echo "")

          # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å¤‰æ›´ãƒã‚§ãƒƒã‚¯
          SCREENSHOTS_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '^apps/cool-app/\.maestro/screenshots/' || echo "")

          # ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®šï¼ˆã©ã¡ã‚‰ã‹ä¸€æ–¹ãŒã‚ã‚Œã°å®Ÿè¡Œï¼‰
          if [ -z "$CODE_CHANGED" ] && [ -z "$SCREENSHOTS_CHANGED" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "skip_reason=ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå¤‰æ›´ã‚‚æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_OUTPUT
            echo "â­ï¸ Maestro VRT Skipped: No code or screenshot changes detected"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Maestro VRT conditions met - proceeding with comparison"
            if [ -n "$CODE_CHANGED" ]; then
              echo "  - Code changes detected"
            fi
            if [ -n "$SCREENSHOTS_CHANGED" ]; then
              echo "  - Screenshot changes detected"
            fi
          fi

      - name: Comment PR - Maestro VRT Skipped
        if: steps.check.outputs.should_run == 'false'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: maestro-vrt-skipped
          message: |
            ## â­ï¸ Maestro VRT Skipped

            **ç†ç”±**: ${{ steps.check.outputs.skip_reason }}

            ---

            ğŸ’¡ **Maestro VRTã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®å¤‰æ›´ãŒå¿…è¦ã§ã™:**
            - ã‚³ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆ`.ts`, `.tsx`, `.js`, `.jsx`, `.json`, `.yaml`ï¼‰
            - ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå¤‰æ›´ï¼ˆ`apps/cool-app/.maestro/screenshots/`ï¼‰

            ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯:
            ```bash
            cd apps/cool-app
            bun run maestro:all # Maestroãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ï¼‰
            ```

      - name: Setup Bun
        if: steps.check.outputs.should_run == 'true'
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        if: steps.check.outputs.should_run == 'true'
        working-directory: apps/cool-app
        run: bun install

      - name: Authenticate to Google Cloud
        if: steps.check.outputs.should_run == 'true'
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.VRT_GCS_CREDENTIALS_JSON }}'

      - name: Workaround for detached HEAD
        if: steps.check.outputs.should_run == 'true'
        run: |
          git checkout ${{ github.head_ref }}

      - name: Compare with baseline
        if: steps.check.outputs.should_run == 'true'
        id: comparison-keys
        working-directory: apps/cool-app
        run: |
          # ãƒ™ãƒ¼ã‚¹å´ï¼ˆEXPECTEDï¼‰ã®å¤‰æ•°ã‚’æ§‹ç¯‰
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          BASE_VERSION=$(git show ${{ github.event.pull_request.base.sha }}:apps/cool-app/app.json | jq -r '.expo.version')
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          BASE_BRANCH_SAFE=$(echo "$BASE_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          EXPECTED_KEY="$BASE_BRANCH_SAFE/$BASE_VERSION/$BASE_HASH/maestro"

          # PRå´ï¼ˆACTUALï¼‰ã®å¤‰æ•°ã‚’æ§‹ç¯‰
          PR_HASH=$(git rev-parse --short=7 HEAD)
          PR_VERSION=$(npx expo config --json | jq -r '.version')
          PR_BRANCH="${{ github.head_ref }}"
          PR_BRANCH_SAFE=$(echo "$PR_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          ACTUAL_KEY="$PR_BRANCH_SAFE/$PR_VERSION/$PR_HASH/maestro"

          echo "ğŸ” Maestro VRT Comparison Keys"
          echo "EXPECTED_KEY: $EXPECTED_KEY"
          echo "ACTUAL_KEY: $ACTUAL_KEY"
          echo ""

          # Output for PR comment
          echo "base-branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "base-branch-safe=$BASE_BRANCH_SAFE" >> $GITHUB_OUTPUT
          echo "base-version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "base-hash=$BASE_HASH" >> $GITHUB_OUTPUT
          echo "pr-branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "pr-branch-safe=$PR_BRANCH_SAFE" >> $GITHUB_OUTPUT
          echo "pr-version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "pr-hash=$PR_HASH" >> $GITHUB_OUTPUT
          echo "expected-key=$EXPECTED_KEY" >> $GITHUB_OUTPUT
          echo "actual-key=$ACTUAL_KEY" >> $GITHUB_OUTPUT

          # reg-suit ã§æ¯”è¼ƒ
          rm -rf .reg
          ACTUAL_DIR=.maestro/screenshots \
          EXPECTED_KEY=$EXPECTED_KEY \
          ACTUAL_KEY=$ACTUAL_KEY \
          bunx reg-suit run

          # æ¯”è¼ƒçµæœã®è©³ç´°ã‚’å‡ºåŠ›
          echo ""
          echo "ğŸ“ .reg directory structure:"
          ls -lah .reg/
          echo ""
          echo "ğŸ“„ VRT comparison result (out.json):"
          jq '.' .reg/out.json

          # VRTçµæœã‚’è§£æ
          CHANGED=$(jq '.diffItems | length' .reg/out.json)
          PASSED=$(jq '.passedItems | length' .reg/out.json)
          NEW=$(jq '.newItems | length' .reg/out.json)
          DELETED=$(jq '.deletedItems | length' .reg/out.json)
          echo "vrt-changed=$CHANGED" >> $GITHUB_OUTPUT
          echo "vrt-passed=$PASSED" >> $GITHUB_OUTPUT
          echo "vrt-new=$NEW" >> $GITHUB_OUTPUT
          echo "vrt-deleted=$DELETED" >> $GITHUB_OUTPUT

      - name: Set GitHub Pages path
        if: steps.check.outputs.should_run == 'true'
        id: pages-path
        run: |
          PR_HASH=$(git rev-parse --short=7 HEAD)
          PR_VERSION=$(cd apps/cool-app && npx expo config --json | jq -r '.version')
          PR_BRANCH="${{ github.head_ref }}"
          PR_BRANCH_SAFE=$(echo "$PR_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          PAGES_PATH="$PR_BRANCH_SAFE/$PR_VERSION/$PR_HASH/maestro"
          echo "path=$PAGES_PATH" >> $GITHUB_OUTPUT
          echo "ğŸ“ GitHub Pages path: $PAGES_PATH"

      - name: Deploy to GitHub Pages
        if: steps.check.outputs.should_run == 'true' && always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/cool-app/.reg
          destination_dir: ${{ steps.pages-path.outputs.path }}
          keep_files: true

      - name: Upload VRT report
        if: steps.check.outputs.should_run == 'true' && always()
        uses: actions/upload-artifact@v5
        with:
          name: maestro-vrt-report
          path: apps/cool-app/.reg/
          retention-days: 30
          include-hidden-files: true

      - name: Comment PR with VRT access methods
        if: steps.check.outputs.should_run == 'true' && always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: maestro-vrt-report
          message: |
            ## ğŸ¼ Maestro VRT Report

            | Status | Count |
            |--------|-------|
            | ğŸ”´ Changed | ${{ steps.comparison-keys.outputs.vrt-changed }} |
            | ğŸŸ¢ Passed | ${{ steps.comparison-keys.outputs.vrt-passed }} |
            | ğŸ†• New | ${{ steps.comparison-keys.outputs.vrt-new }} |
            | ğŸ—‘ï¸ Deleted | ${{ steps.comparison-keys.outputs.vrt-deleted }} |

            ğŸ”— **View Report**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.pages-path.outputs.path }}/

            <details>
            <summary>ğŸ“‹ è©³ç´°æƒ…å ±</summary>

            ### â±ï¸ ä¿å­˜æœŸé–“
            ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ **30æ—¥é–“ä¿å­˜** ã•ã‚Œã¾ã™ï¼ˆãã®å¾Œè‡ªå‹•å‰Šé™¤ï¼‰ã€‚

            ### ğŸ’» ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
            ```bash
            cd apps/cool-app
            rm -rf .reg
            mkdir -p .reg
            gsutil -m cp -r "gs://vrt-sample/${{ steps.comparison-keys.outputs.actual-key }}" .reg
            open .reg/maestro/index.html
            ```

            ### ğŸ“Š æ¯”è¼ƒæƒ…å ±
            - **Base**: `${{ steps.comparison-keys.outputs.expected-key }}`
            - **PR**: `${{ steps.comparison-keys.outputs.actual-key }}`

            </details>

            ---
            *Powered by reg-suit + GitHub Pages*

      - name: Summary
        if: steps.check.outputs.should_run == 'true' && always()
        run: |
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          PR_HASH=$(git rev-parse --short=7 HEAD)
          echo "## Maestro VRT Comparison" >> $GITHUB_STEP_SUMMARY
          echo "- Base: $BASE_HASH" >> $GITHUB_STEP_SUMMARY
          echo "- PR: $PR_HASH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Maestro VRTæ¯”è¼ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Playwright VRT
  # ========================================
  playwright-vrt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check VRT conditions
        id: check
        run: |
          echo "ğŸ” Checking Playwright VRT execution conditions..."

          # ã‚³ãƒ¼ãƒ‰ç³»ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãƒã‚§ãƒƒã‚¯
          CODE_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '\.(ts|tsx|js|jsx|json|yaml)$' || echo "")

          if [ -z "$CODE_CHANGED" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "skip_reason=ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_OUTPUT
            echo "â­ï¸ Playwright VRT Skipped: No code changes detected"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Playwright VRT conditions met - proceeding with comparison"
          fi

      - name: Comment PR - Playwright VRT Skipped
        if: steps.check.outputs.should_run == 'false'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: playwright-vrt-skipped
          message: |
            ## â­ï¸ Playwright VRT Skipped

            **ç†ç”±**: ${{ steps.check.outputs.skip_reason }}

            ---

            ğŸ’¡ **Playwright VRTã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒå¿…è¦ã§ã™:**
            - ã‚³ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆ`.ts`, `.tsx`, `.js`, `.jsx`, `.json`, `.yaml`ï¼‰

      - name: Setup Bun
        if: steps.check.outputs.should_run == 'true'
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        if: steps.check.outputs.should_run == 'true'
        working-directory: apps/cool-app
        run: bun install

      - name: Install Playwright browsers
        if: steps.check.outputs.should_run == 'true'
        working-directory: apps/cool-app
        run: bunx playwright install chromium --with-deps

      - name: Run Playwright tests
        if: steps.check.outputs.should_run == 'true'
        working-directory: apps/cool-app
        run: bun run playwright:web
        env:
          CI: true

      - name: Authenticate to Google Cloud
        if: steps.check.outputs.should_run == 'true'
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.VRT_GCS_CREDENTIALS_JSON }}'

      - name: Workaround for detached HEAD
        if: steps.check.outputs.should_run == 'true'
        run: |
          git checkout ${{ github.head_ref }}

      - name: Compare with baseline
        if: steps.check.outputs.should_run == 'true'
        id: comparison-keys
        working-directory: apps/cool-app
        run: |
          # ãƒ™ãƒ¼ã‚¹å´ï¼ˆEXPECTEDï¼‰
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          BASE_VERSION=$(git show ${{ github.event.pull_request.base.sha }}:apps/cool-app/app.json | jq -r '.expo.version')
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          BASE_BRANCH_SAFE=$(echo "$BASE_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          EXPECTED_KEY="$BASE_BRANCH_SAFE/$BASE_VERSION/$BASE_HASH/playwright"

          # PRå´ï¼ˆACTUALï¼‰
          PR_HASH=$(git rev-parse --short=7 HEAD)
          PR_VERSION=$(npx expo config --json | jq -r '.version')
          PR_BRANCH="${{ github.head_ref }}"
          PR_BRANCH_SAFE=$(echo "$PR_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          ACTUAL_KEY="$PR_BRANCH_SAFE/$PR_VERSION/$PR_HASH/playwright"

          echo "ğŸ” Playwright VRT Comparison Keys"
          echo "EXPECTED_KEY: $EXPECTED_KEY"
          echo "ACTUAL_KEY: $ACTUAL_KEY"
          echo ""

          # Output for PR comment
          echo "base-hash=$BASE_HASH" >> $GITHUB_OUTPUT
          echo "pr-hash=$PR_HASH" >> $GITHUB_OUTPUT
          echo "expected-key=$EXPECTED_KEY" >> $GITHUB_OUTPUT
          echo "actual-key=$ACTUAL_KEY" >> $GITHUB_OUTPUT

          # reg-suit ã§æ¯”è¼ƒ
          rm -rf .reg
          ACTUAL_DIR=e2e/screenshots \
          EXPECTED_KEY=$EXPECTED_KEY \
          ACTUAL_KEY=$ACTUAL_KEY \
          bunx reg-suit run

          # æ¯”è¼ƒçµæœã®è©³ç´°ã‚’å‡ºåŠ›
          echo ""
          echo "ğŸ“ .reg directory structure:"
          ls -lah .reg/
          echo ""
          echo "ğŸ“„ VRT comparison result (out.json):"
          jq '.' .reg/out.json

          # VRTçµæœã‚’è§£æ
          CHANGED=$(jq '.diffItems | length' .reg/out.json)
          PASSED=$(jq '.passedItems | length' .reg/out.json)
          NEW=$(jq '.newItems | length' .reg/out.json)
          DELETED=$(jq '.deletedItems | length' .reg/out.json)
          echo "vrt-changed=$CHANGED" >> $GITHUB_OUTPUT
          echo "vrt-passed=$PASSED" >> $GITHUB_OUTPUT
          echo "vrt-new=$NEW" >> $GITHUB_OUTPUT
          echo "vrt-deleted=$DELETED" >> $GITHUB_OUTPUT

      - name: Set GitHub Pages path
        if: steps.check.outputs.should_run == 'true'
        id: pages-path
        run: |
          PR_HASH=$(git rev-parse --short=7 HEAD)
          PR_VERSION=$(cd apps/cool-app && npx expo config --json | jq -r '.version')
          PR_BRANCH="${{ github.head_ref }}"
          PR_BRANCH_SAFE=$(echo "$PR_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          PAGES_PATH="$PR_BRANCH_SAFE/$PR_VERSION/$PR_HASH/playwright"
          echo "path=$PAGES_PATH" >> $GITHUB_OUTPUT
          echo "ğŸ“ GitHub Pages path: $PAGES_PATH"

      - name: Deploy to GitHub Pages
        if: steps.check.outputs.should_run == 'true' && always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/cool-app/.reg
          destination_dir: ${{ steps.pages-path.outputs.path }}
          keep_files: true

      - name: Upload VRT report
        if: steps.check.outputs.should_run == 'true' && always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-vrt-report
          path: apps/cool-app/.reg/
          retention-days: 30
          include-hidden-files: true

      - name: Comment PR with VRT access methods
        if: steps.check.outputs.should_run == 'true' && always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: playwright-vrt-report
          message: |
            ## ğŸ­ Playwright VRT Report

            | Status | Count |
            |--------|-------|
            | ğŸ”´ Changed | ${{ steps.comparison-keys.outputs.vrt-changed }} |
            | ğŸŸ¢ Passed | ${{ steps.comparison-keys.outputs.vrt-passed }} |
            | ğŸ†• New | ${{ steps.comparison-keys.outputs.vrt-new }} |
            | ğŸ—‘ï¸ Deleted | ${{ steps.comparison-keys.outputs.vrt-deleted }} |

            ğŸ”— **View Report**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.pages-path.outputs.path }}/

            <details>
            <summary>ğŸ“‹ è©³ç´°æƒ…å ±</summary>

            ### â±ï¸ ä¿å­˜æœŸé–“
            ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ **30æ—¥é–“ä¿å­˜** ã•ã‚Œã¾ã™ï¼ˆãã®å¾Œè‡ªå‹•å‰Šé™¤ï¼‰ã€‚

            ### ğŸ’» ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
            ```bash
            cd apps/cool-app
            rm -rf .reg
            mkdir -p .reg
            gsutil -m cp -r "gs://vrt-sample/${{ steps.comparison-keys.outputs.actual-key }}" .reg
            open .reg/playwright/index.html
            ```

            ### ğŸ“Š æ¯”è¼ƒæƒ…å ±
            - **Base**: `${{ steps.comparison-keys.outputs.expected-key }}`
            - **PR**: `${{ steps.comparison-keys.outputs.actual-key }}`

            </details>

            ---
            *Powered by reg-suit + Playwright + GitHub Pages*

      - name: Summary
        if: steps.check.outputs.should_run == 'true' && always()
        run: |
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          PR_HASH=$(git rev-parse --short=7 HEAD)
          echo "## Playwright VRT Comparison" >> $GITHUB_STEP_SUMMARY
          echo "- Base: $BASE_HASH" >> $GITHUB_STEP_SUMMARY
          echo "- PR: $PR_HASH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Playwright VRTæ¯”è¼ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
