name: VRT PR Comparison

# PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸã¨ãã«VRTæ¯”è¼ƒã‚’å®Ÿè¡Œ
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write       # peaceiris/actions-gh-pages ãŒ gh-pages ã«push
  pull-requests: write  # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
  statuses: write       # ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
  pages: write          # GitHub Pages ã¸ã®æ›¸ãè¾¼ã¿
  id-token: write       # OIDC ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ç”¨

jobs:
  vrt-compare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        working-directory: apps/cool-app
        run: bun install

      # Maestroã¯äº‹å‰ã«å®Ÿè¡Œæ¸ˆã¿ï¼ˆ.maestro/screenshots ãŒå­˜åœ¨ã™ã‚‹å‰æï¼‰

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.VRT_GCS_CREDENTIALS_JSON }}'

      - name: Publish PR snapshot to GCS (2 keys)
        working-directory: apps/cool-app
        run: |
          # ãƒãƒƒã‚·ãƒ¥ã®ã¿ã®ã‚­ãƒ¼ï¼ˆæ¯”è¼ƒç”¨ï¼‰
          PR_HASH=$(git rev-parse --short=7 HEAD)
          echo "ðŸ” Debug Info (Command 1)"
          echo "PR_HASH: $PR_HASH"
          rm -rf .reg && ACTUAL_KEY=$PR_HASH bunx reg-suit run

          # ãƒ•ãƒ«ãƒ‘ã‚¹ã®ã‚­ãƒ¼ï¼ˆå±¥æ­´ä¿å­˜ç”¨ï¼‰
          BRANCH="${{ github.head_ref }}"
          BRANCH_SAFE=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          VERSION=$(jq -r '.version' package.json)
          FULL_KEY="$BRANCH_SAFE/$VERSION/$PR_HASH"
          echo "ðŸ” Debug Info (Command 2)"
          echo "BRANCH: $BRANCH"
          echo "BRANCH_SAFE: $BRANCH_SAFE"
          echo "VERSION: $VERSION"
          echo "FULL_KEY: $FULL_KEY"
          rm -rf .reg && ACTUAL_KEY=$FULL_KEY bunx reg-suit run

      # GitHub Actionsã®PRã‚¤ãƒ™ãƒ³ãƒˆã§ã¯detached HEADçŠ¶æ…‹ã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã•ã‚Œã‚‹ãŸã‚ã€
      # reg-notify-github-pluginãŒãƒ–ãƒ©ãƒ³ãƒåã‚’æ¤œå‡ºã§ããšã€PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã§ããªã„ã€‚
      # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã€‚
      - name: Workaround for detached HEAD
        run: |
          git checkout ${{ github.head_ref }}

      - name: Compare with baseline
        working-directory: apps/cool-app
        run: |
          # ãƒ•ãƒ«ãƒ‘ã‚¹ã®ã‚­ãƒ¼ã§æ¯”è¼ƒ
          # ãƒ™ãƒ¼ã‚¹å´ï¼ˆEXPECTEDï¼‰ã®å¤‰æ•°ã‚’æ§‹ç¯‰
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          BASE_VERSION=$(git show ${{ github.event.pull_request.base.sha }}:apps/cool-app/package.json | jq -r '.version')
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          BASE_BRANCH_SAFE=$(echo "$BASE_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          EXPECTED_KEY="$BASE_BRANCH_SAFE/$BASE_VERSION/$BASE_HASH"

          # PRå´ï¼ˆACTUALï¼‰ã®å¤‰æ•°ã‚’æ§‹ç¯‰
          PR_HASH=$(git rev-parse --short=7 HEAD)
          PR_VERSION=$(jq -r '.version' package.json)
          PR_BRANCH="${{ github.head_ref }}"
          PR_BRANCH_SAFE=$(echo "$PR_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          ACTUAL_KEY="$PR_BRANCH_SAFE/$PR_VERSION/$PR_HASH"

          echo "ðŸ” VRT Comparison Debug Info"
          echo "Base branch: $BASE_BRANCH"
          echo "Base version: $BASE_VERSION"
          echo "Base commit: $BASE_HASH"
          echo "EXPECTED_KEY: $EXPECTED_KEY"
          echo ""
          echo "PR branch: $PR_BRANCH"
          echo "PR version: $PR_VERSION"
          echo "PR commit: $PR_HASH"
          echo "ACTUAL_KEY: $ACTUAL_KEY"
          echo ""

          # ãƒ•ãƒ«ãƒ‘ã‚¹ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦æ¯”è¼ƒ
          rm -rf .reg && EXPECTED_KEY=$EXPECTED_KEY ACTUAL_KEY=$ACTUAL_KEY bunx reg-suit run

          # ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆãƒãƒƒã‚·ãƒ¥ã®ã¿ã§æ¯”è¼ƒã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã‚’ä½¿ç”¨ï¼‰
          # rm -rf .reg && EXPECTED_KEY=$BASE_HASH ACTUAL_KEY=$PR_HASH bunx reg-suit run

          # æ¯”è¼ƒçµæžœã®è©³ç´°ã‚’å‡ºåŠ›
          echo ""
          echo "ðŸ“ .reg directory structure:"
          ls -lah .reg/
          echo ""
          echo "ðŸ“„ VRT comparison result (out.json):"
          jq '.' .reg/out.json

      - name: Set GitHub Pages path
        id: pages-path
        run: |
          PR_HASH=$(git rev-parse --short=7 HEAD)
          PR_VERSION=$(jq -r '.version' apps/cool-app/package.json)
          PR_BRANCH="${{ github.head_ref }}"
          PR_BRANCH_SAFE=$(echo "$PR_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          PAGES_PATH="vrt-sample/$PR_BRANCH_SAFE/$PR_VERSION/$PR_HASH"
          echo "path=$PAGES_PATH" >> $GITHUB_OUTPUT
          echo "ðŸ“ GitHub Pages path: $PAGES_PATH"

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/cool-app/.reg
          destination_dir: ${{ steps.pages-path.outputs.path }}
          keep_files: true

      - name: Upload VRT report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: vrt-report
          path: apps/cool-app/.reg/
          retention-days: 30
          include-hidden-files: true  # .reg/ ã¯éš ã—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãŸã‚å¿…é ˆ

      - name: Comment PR with GitHub Pages URL
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: vrt-report
          message: |
            ## ðŸ“Š VRT Report (GitHub Pages)

            ðŸ”— **View Report**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.pages-path.outputs.path }}/

            ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯PRãƒžãƒ¼ã‚¸å¾Œã‚‚æ°¸ç¶šçš„ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚

            ---
            *Powered by reg-suit + GitHub Pages*

      - name: Summary
        if: always()
        run: |
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          PR_HASH=$(git rev-parse --short=7 HEAD)
          echo "## VRT Comparison" >> $GITHUB_STEP_SUMMARY
          echo "- Base: $BASE_HASH" >> $GITHUB_STEP_SUMMARY
          echo "- PR: $PR_HASH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… VRTæ¯”è¼ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
