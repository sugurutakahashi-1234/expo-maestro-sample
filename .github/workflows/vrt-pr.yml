name: VRT PR Comparison

# PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸã¨ãã«VRTæ¯”è¼ƒã‚’å®Ÿè¡Œ
#
# Note: ä»£æ›¿å®Ÿè£…æ¡ˆ
# ã‚¸ãƒ§ãƒ–ã‚’2ã¤ã«åˆ†å‰²ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ï¼ˆcheck-conditions + vrt-compareï¼‰
# ãƒ¡ãƒªãƒƒãƒˆ: å„ã‚¹ãƒ†ãƒƒãƒ—ã«æ¡ä»¶ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒãªã„ã€ã‚¸ãƒ§ãƒ–å…¨ä½“ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
# ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãŒ2å›žå®Ÿè¡Œã•ã‚Œã‚‹
# ç¾åœ¨ã®å®Ÿè£…ã¯ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’å„ªå…ˆã—ã¦1ã‚¸ãƒ§ãƒ–ã§æ¡ä»¶åˆ†å²ã—ã¦ã„ã‚‹
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write       # peaceiris/actions-gh-pages ãŒ gh-pages ã«push
  pull-requests: write  # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
  statuses: write       # ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
  pages: write          # GitHub Pages ã¸ã®æ›¸ãè¾¼ã¿
  id-token: write       # OIDC ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ç”¨

jobs:
  vrt-compare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Check VRT conditions
        id: check
        run: |
          echo "ðŸ” Checking VRT execution conditions..."

          # ã‚³ãƒ¼ãƒ‰ç³»ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãƒã‚§ãƒƒã‚¯ï¼ˆ.ts, .tsx, .js, .jsx, .json, .yamlï¼‰
          CODE_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '\.(ts|tsx|js|jsx|json|yaml)$' || echo "")

          # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å¤‰æ›´ãƒã‚§ãƒƒã‚¯
          SCREENSHOTS_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '^apps/cool-app/\.maestro/screenshots/' || echo "")

          # ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®šï¼ˆã©ã¡ã‚‰ã‹ä¸€æ–¹ãŒã‚ã‚Œã°å®Ÿè¡Œï¼‰
          if [ -z "$CODE_CHANGED" ] && [ -z "$SCREENSHOTS_CHANGED" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "skip_reason=ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå¤‰æ›´ã‚‚æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_OUTPUT
            echo "â­ï¸ VRT Skipped: No code or screenshot changes detected"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… VRT conditions met - proceeding with comparison"
            if [ -n "$CODE_CHANGED" ]; then
              echo "  - Code changes detected"
            fi
            if [ -n "$SCREENSHOTS_CHANGED" ]; then
              echo "  - Screenshot changes detected"
            fi
          fi

      - name: Comment PR - VRT Skipped
        if: steps.check.outputs.should_run == 'false'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: vrt-skipped
          message: |
            ## â­ï¸ VRT Skipped

            **ç†ç”±**: ${{ steps.check.outputs.skip_reason }}

            ---

            ðŸ’¡ **VRTã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®å¤‰æ›´ãŒå¿…è¦ã§ã™:**
            - ã‚³ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆ`.ts`, `.tsx`, `.js`, `.jsx`, `.json`, `.yaml`ï¼‰
            - ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå¤‰æ›´ï¼ˆ`apps/cool-app/.maestro/screenshots/`ï¼‰

            ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯:
            ```bash
            cd apps/cool-app
            bun run maestro:all # Maestroãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ï¼‰
            ```

      - name: Setup Bun
        if: steps.check.outputs.should_run == 'true'
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        if: steps.check.outputs.should_run == 'true'
        working-directory: apps/cool-app
        run: bun install

      # Maestroã¯äº‹å‰ã«å®Ÿè¡Œæ¸ˆã¿ï¼ˆ.maestro/screenshots ãŒå­˜åœ¨ã™ã‚‹å‰æï¼‰

      - name: Authenticate to Google Cloud
        if: steps.check.outputs.should_run == 'true'
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.VRT_GCS_CREDENTIALS_JSON }}'

      # Note: ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ä¸è¦ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¸ˆã¿ï¼‰
      # ç†ç”±: "Compare with baseline" ã‚¹ãƒ†ãƒƒãƒ—ã§ `reg-suit run` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€
      # è‡ªå‹•çš„ã« compare + publish + notify ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€äº‹å‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ä¸è¦ã€‚
      # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ï¼š
      # 1. åŒã˜ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒ2å›žã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ï¼ˆç„¡é§„ï¼‰
      # 2. 2ã¤ã® GitHub ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆé‡è¤‡è¡¨ç¤ºï¼‰
      # 3. å‡¦ç†æ™‚é–“ãŒå¢—åŠ ã™ã‚‹
      #
      # - name: Publish PR snapshot to GCS (2 keys)
      #   working-directory: apps/cool-app
      #   run: |
      #     # ãƒãƒƒã‚·ãƒ¥ã®ã¿ã®ã‚­ãƒ¼ï¼ˆæ¯”è¼ƒç”¨ï¼‰
      #     PR_HASH=$(git rev-parse --short=7 HEAD)
      #     echo "ðŸ” Debug Info (Command 1)"
      #     echo "PR_HASH: $PR_HASH"
      #     rm -rf .reg && ACTUAL_KEY=$PR_HASH bunx reg-suit run
      #
      #     # ãƒ•ãƒ«ãƒ‘ã‚¹ã®ã‚­ãƒ¼ï¼ˆå±¥æ­´ä¿å­˜ç”¨ï¼‰
      #     BRANCH="${{ github.head_ref }}"
      #     BRANCH_SAFE=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
      #     VERSION=$(jq -r '.version' package.json)
      #     FULL_KEY="$BRANCH_SAFE/$VERSION/$PR_HASH"
      #     echo "ðŸ” Debug Info (Command 2)"
      #     echo "BRANCH: $BRANCH"
      #     echo "BRANCH_SAFE: $BRANCH_SAFE"
      #     echo "VERSION: $VERSION"
      #     echo "FULL_KEY: $FULL_KEY"
      #     rm -rf .reg && ACTUAL_KEY=$FULL_KEY bunx reg-suit run

      # GitHub Actionsã®PRã‚¤ãƒ™ãƒ³ãƒˆã§ã¯detached HEADçŠ¶æ…‹ã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã•ã‚Œã‚‹ãŸã‚ã€
      # reg-notify-github-pluginãŒãƒ–ãƒ©ãƒ³ãƒåã‚’æ¤œå‡ºã§ããšã€PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã§ããªã„ã€‚
      # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã€‚
      - name: Workaround for detached HEAD
        if: steps.check.outputs.should_run == 'true'
        run: |
          git checkout ${{ github.head_ref }}

      - name: Compare with baseline
        if: steps.check.outputs.should_run == 'true'
        id: comparison-keys
        working-directory: apps/cool-app
        run: |
          # ãƒ•ãƒ«ãƒ‘ã‚¹ã®ã‚­ãƒ¼ã§æ¯”è¼ƒ
          # ãƒ™ãƒ¼ã‚¹å´ï¼ˆEXPECTEDï¼‰ã®å¤‰æ•°ã‚’æ§‹ç¯‰
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          BASE_VERSION=$(git show ${{ github.event.pull_request.base.sha }}:apps/cool-app/package.json | jq -r '.version')
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          BASE_BRANCH_SAFE=$(echo "$BASE_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          EXPECTED_KEY="$BASE_BRANCH_SAFE/$BASE_VERSION/$BASE_HASH"

          # PRå´ï¼ˆACTUALï¼‰ã®å¤‰æ•°ã‚’æ§‹ç¯‰
          PR_HASH=$(git rev-parse --short=7 HEAD)
          PR_VERSION=$(jq -r '.version' package.json)
          PR_BRANCH="${{ github.head_ref }}"
          PR_BRANCH_SAFE=$(echo "$PR_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          ACTUAL_KEY="$PR_BRANCH_SAFE/$PR_VERSION/$PR_HASH"

          echo "ðŸ” VRT Comparison Keys"
          echo "EXPECTED_KEY: $EXPECTED_KEY"
          echo "ACTUAL_KEY: $ACTUAL_KEY"
          echo ""

          # Output for PR comment
          echo "base-branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "base-branch-safe=$BASE_BRANCH_SAFE" >> $GITHUB_OUTPUT
          echo "base-version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "base-hash=$BASE_HASH" >> $GITHUB_OUTPUT
          echo "pr-branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "pr-branch-safe=$PR_BRANCH_SAFE" >> $GITHUB_OUTPUT
          echo "pr-version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "pr-hash=$PR_HASH" >> $GITHUB_OUTPUT
          echo "expected-key=$EXPECTED_KEY" >> $GITHUB_OUTPUT
          echo "actual-key=$ACTUAL_KEY" >> $GITHUB_OUTPUT

          # ãƒ•ãƒ«ãƒ‘ã‚¹ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦æ¯”è¼ƒ
          rm -rf .reg && EXPECTED_KEY=$EXPECTED_KEY ACTUAL_KEY=$ACTUAL_KEY bunx reg-suit run

          # ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆãƒãƒƒã‚·ãƒ¥ã®ã¿ã§æ¯”è¼ƒã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã‚’ä½¿ç”¨ï¼‰
          # rm -rf .reg && EXPECTED_KEY=$BASE_HASH ACTUAL_KEY=$PR_HASH bunx reg-suit run

          # æ¯”è¼ƒçµæžœã®è©³ç´°ã‚’å‡ºåŠ›
          echo ""
          echo "ðŸ“ .reg directory structure:"
          ls -lah .reg/
          echo ""
          echo "ðŸ“„ VRT comparison result (out.json):"
          jq '.' .reg/out.json

      - name: Set GitHub Pages path
        if: steps.check.outputs.should_run == 'true'
        id: pages-path
        run: |
          PR_HASH=$(git rev-parse --short=7 HEAD)
          PR_VERSION=$(jq -r '.version' apps/cool-app/package.json)
          PR_BRANCH="${{ github.head_ref }}"
          PR_BRANCH_SAFE=$(echo "$PR_BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          PAGES_PATH="vrt-sample/$PR_BRANCH_SAFE/$PR_VERSION/$PR_HASH"
          echo "path=$PAGES_PATH" >> $GITHUB_OUTPUT
          echo "ðŸ“ GitHub Pages path: $PAGES_PATH"

      - name: Deploy to GitHub Pages
        if: steps.check.outputs.should_run == 'true' && always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/cool-app/.reg
          destination_dir: ${{ steps.pages-path.outputs.path }}
          keep_files: true

      - name: Upload VRT report
        if: steps.check.outputs.should_run == 'true' && always()
        uses: actions/upload-artifact@v5
        with:
          name: vrt-report
          path: apps/cool-app/.reg/
          retention-days: 30
          include-hidden-files: true  # .reg/ ã¯éš ã—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãŸã‚å¿…é ˆ

      - name: Comment PR with VRT access methods
        if: steps.check.outputs.should_run == 'true' && always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: vrt-report
          message: |
            ## ðŸ“Š VRT Report

            ### ðŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºï¼ˆGitHub Pagesï¼‰

            ðŸ”— **View Report**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.pages-path.outputs.path }}/

            â±ï¸ ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ **30æ—¥é–“ä¿å­˜** ã•ã‚Œã¾ã™ï¼ˆãã®å¾Œè‡ªå‹•å‰Šé™¤ï¼‰ã€‚

            ---

            ### ðŸ’» ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º

            **æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:**
            ```bash
            cd apps/cool-app
            rm -rf .reg
            mkdir -p .reg
            gsutil -m cp -r "gs://vrt-sample/${{ steps.comparison-keys.outputs.actual-key }}" .reg
            open .reg/${{ steps.comparison-keys.outputs.pr-hash }}/index.html
            ```

            ---

            ### ðŸ“Š æ¯”è¼ƒæƒ…å ±

            - **Base**: `${{ steps.comparison-keys.outputs.expected-key }}`
            - **PR**: `${{ steps.comparison-keys.outputs.actual-key }}`

            ---
            *Powered by reg-suit + GitHub Pages*

      - name: Summary
        if: steps.check.outputs.should_run == 'true' && always()
        run: |
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          PR_HASH=$(git rev-parse --short=7 HEAD)
          echo "## VRT Comparison" >> $GITHUB_STEP_SUMMARY
          echo "- Base: $BASE_HASH" >> $GITHUB_STEP_SUMMARY
          echo "- PR: $PR_HASH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… VRTæ¯”è¼ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
