name: VRT PR Comparison

# PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸã¨ãã«VRTæ¯”è¼ƒã‚’å®Ÿè¡Œ
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read        # ãƒªãƒã‚¸ãƒˆãƒªèª­ã¿å–ã‚Š
  pull-requests: write  # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
  statuses: write       # ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š

jobs:
  vrt-compare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        working-directory: apps/cool-app
        run: bun install

      # Maestroã¯äº‹å‰ã«å®Ÿè¡Œæ¸ˆã¿ï¼ˆ.maestro/screenshots ãŒå­˜åœ¨ã™ã‚‹å‰æï¼‰

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.VRT_GCS_CREDENTIALS_JSON }}'

      - name: Publish PR snapshot to GCS (2 keys)
        working-directory: apps/cool-app
        run: |
          # ã‚³ãƒžãƒ³ãƒ‰1: ãƒãƒƒã‚·ãƒ¥ã®ã¿ã®ã‚­ãƒ¼ï¼ˆæ¯”è¼ƒç”¨ï¼‰
          PR_HASH=$(git rev-parse --short=7 HEAD)
          echo "ðŸ” Debug Info (Command 1)"
          echo "PR_HASH: $PR_HASH"
          rm -rf .reg && ACTUAL_KEY=$PR_HASH bunx reg-suit run

          # ã‚³ãƒžãƒ³ãƒ‰2: ãƒ•ãƒ«ãƒ‘ã‚¹ã®ã‚­ãƒ¼ï¼ˆå±¥æ­´ä¿å­˜ç”¨ï¼‰
          BRANCH="${{ github.head_ref }}"
          BRANCH_SAFE=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9._-]/_/g')
          VERSION=$(jq -r '.version' package.json)
          FULL_KEY="$BRANCH_SAFE/$VERSION/$PR_HASH"
          echo "ðŸ” Debug Info (Command 2)"
          echo "BRANCH: $BRANCH"
          echo "BRANCH_SAFE: $BRANCH_SAFE"
          echo "VERSION: $VERSION"
          echo "FULL_KEY: $FULL_KEY"
          rm -rf .reg && ACTUAL_KEY=$FULL_KEY bunx reg-suit run

      - name: Workaround for detached HEAD
        run: |
          git checkout ${{ github.head_ref }} || git checkout -b ${{ github.head_ref }}

      - name: Compare with baseline
        working-directory: apps/cool-app
        run: |
          # ãƒãƒƒã‚·ãƒ¥ã®ã¿ã®ã‚­ãƒ¼ã§æ¯”è¼ƒ
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          PR_HASH=$(git rev-parse --short=7 HEAD)

          echo "ðŸ” VRT Comparison Debug Info"
          echo "Base branch: ${{ github.event.pull_request.base.ref }}"
          echo "Base commit: $BASE_HASH"
          echo "PR branch: ${{ github.head_ref }}"
          echo "PR commit: $PR_HASH"
          echo ""

          # PR_HASH ãŒ actual (æ–°ã—ã„), BASE_HASH ãŒ expected (å¤ã„)
          # ãƒãƒƒã‚·ãƒ¥ã®ã¿ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨
          rm -rf .reg && EXPECTED_KEY=$BASE_HASH ACTUAL_KEY=$PR_HASH bunx reg-suit run

          # æ¯”è¼ƒçµæžœã®è©³ç´°ã‚’å‡ºåŠ›
          echo ""
          echo "ðŸ“ .reg directory structure:"
          ls -lah .reg/
          echo ""
          echo "ðŸ“„ VRT comparison result (out.json):"
          cat .reg/out.json

      - name: Upload VRT report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: vrt-report
          path: apps/cool-app/.reg/
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          BASE_HASH=$(git rev-parse --short=7 ${{ github.event.pull_request.base.sha }})
          PR_HASH=$(git rev-parse --short=7 HEAD)
          echo "## VRT Comparison" >> $GITHUB_STEP_SUMMARY
          echo "- Base: $BASE_HASH" >> $GITHUB_STEP_SUMMARY
          echo "- PR: $PR_HASH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… VRTæ¯”è¼ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
