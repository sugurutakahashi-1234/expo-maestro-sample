name: Cleanup Old VRT Reports

# æ¯Žé€±æ—¥æ›œæ—¥ 0æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ = æ—¥æœ¬æ™‚é–“ æ—¥æ›œæ—¥ 9æ™‚
on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write  # gh-pages ãƒ–ãƒ©ãƒ³ãƒã¸ã®æ›¸ãè¾¼ã¿

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—

      - name: Delete reports older than 30 days
        run: |
          echo "ðŸ—‘ï¸ Deleting VRT reports older than 30 days..."

          # vrt-sample ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®30æ—¥ä»¥ä¸Šå¤ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
          if [ -d "vrt-sample" ]; then
            find vrt-sample -type d -mtime +30 -print -exec rm -rf {} + 2>/dev/null || true

            # å‰Šé™¤å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
            echo ""
            echo "ðŸ“Š Remaining reports:"
            du -sh vrt-sample/* 2>/dev/null || echo "No reports remaining"
          else
            echo "âš ï¸ vrt-sample directory not found"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet && git diff --cached --quiet; then
            echo "âœ¨ No old reports to delete"
          else
            git add -A
            git commit -m "chore: cleanup VRT reports older than 30 days"
            git push
            echo "âœ… Old reports deleted and pushed"
          fi

      - name: Report disk usage and check size limit
        if: always()
        run: |
          echo "## ðŸ“Š GitHub Pages Disk Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "vrt-sample" ]; then
            # ã‚µã‚¤ã‚ºã‚’å–å¾—ï¼ˆMBå˜ä½ï¼‰
            SIZE_MB=$(du -sm vrt-sample 2>/dev/null | cut -f1)
            echo "Current total size: **${SIZE_MB}MB**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # 500MBè¶…éŽãƒã‚§ãƒƒã‚¯
            if [ "$SIZE_MB" -gt 500 ]; then
              echo "### âš ï¸ WARNING: Size Limit Alert" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "VRT reports size is **${SIZE_MB}MB** (>500MB threshold)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Recommended actions:**" >> $GITHUB_STEP_SUMMARY
              echo "- Consider reducing retention period (30 days â†’ 14 days)" >> $GITHUB_STEP_SUMMARY
              echo "- GitHub Pages limit is 1GB (1000MB)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # 800MBè¶…éŽãƒã‚§ãƒƒã‚¯ï¼ˆç·Šæ€¥è­¦å‘Šï¼‰
            if [ "$SIZE_MB" -gt 800 ]; then
              echo "### ðŸš¨ CRITICAL: Near GitHub Pages Limit!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Size is **${SIZE_MB}MB** (>80% of 1GB limit)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**URGENT: Take action immediately!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            echo "### Detailed breakdown:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            du -sh vrt-sample 2>/dev/null
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Recent 20 reports:" >> $GITHUB_STEP_SUMMARY
            du -sh vrt-sample/*/* 2>/dev/null | tail -20 || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ vrt-sample directory not found" >> $GITHUB_STEP_SUMMARY
          fi
